<html>
  <head>
    <style>/*%landingpage.scss%*/</style>
    <script>/*%sortable.js%*/</script>

  </head>
  <body class="landingpage col" data-vscode-context='{"preventDefaultContextMenuItems": true }' onmouseup="stopdrag(event)">
    <div class="modal hidden" onpointerup="modalHide(event)">
      <!-- <div class="dialog col">
        <div class="text">
          <div>Hello World</div>
        </div>
        <div class="actions">
          <button>Ok</button>
        </div> -->
        <div class="palette">
          <div data-shade="red" onclick="modalPaletteClick(event)"></div>
          <div data-shade="orange" onclick="modalPaletteClick(event)"></div>
          <div data-shade="yellow" onclick="modalPaletteClick(event)"></div>
          <div data-shade="green" onclick="modalPaletteClick(event)"></div>
          <div data-shade="teal" onclick="modalPaletteClick(event)"></div>
          <div data-shade="pink" onclick="modalPaletteClick(event)"></div>
          <div data-shade="purple" onclick="modalPaletteClick(event)"></div>
          <div data-shade="blue" onclick="modalPaletteClick(event)"></div>
          <div data-shade="cyan" onclick="modalPaletteClick(event)"></div>
          <div data-shade="gray" onclick="modalPaletteClick(event)"></div>
          <div data-shade="silver" onclick="modalPaletteClick(event)"></div>
          <div data-shade="brown" onclick="modalPaletteClick(event)"></div>
          <div data-shade="white" onclick="modalPaletteClick(event)"></div>
          <div data-shade="black" onclick="modalPaletteClick(event)"></div>
          <div data-shade="" onclick="modalPaletteClick(event)"></div>
        </div>
      </div>
    </div>
    <div class="group col">
      <div data-prototype data-guid="" class="group">
        <div class="dragup"></div>
        <div class="dragdown"></div>
        <div class="titlebar">
          <!--<div class="tools">
            <button title="Collapse/Expand">${eye} </button>
          </div>-->
          <div class="tools">
            <div title="Change order" class="movegrip" onmousedown="startdrag(event)">${gripVertical}</div>
          </div>
          <h1 class="group-label ifn-sealed" data-field="group.label" onclick="rename(event)" title="Click to rename">Group label</h1>
          <div class="tools hover-only ifn-sealed">          
            <!-- <button title="Layout as Grid">${layoutGrid} </button>
            <button title="Layout as List">${layoutList} </button> -->
            <button title="Add bookmark to file or workspace" onclick="createBookmark(false)">${plus} </button>
            <button title="Add bookmark to folder" onclick="createBookmark(true)">${folderPlus} </button>
          </div>
          <space></space>
          <div class="tools">
            <button class="ifn-sealed" title="Remove Group &#013;Shift+Click to skip confirmation" onclick="remove(event)">${circleX} </button>
          </div>
        </div>
        <div class="projects grid">
          <div data-prototype data-guid="" class="project"  data-vscode-context='{"webviewSection": "card", "preventDefaultContextMenuItems": true}' oncontextmenu="modalPaletteShow(event)">
            <div class="dragbefore ifn-sealed"></div>
            <div class="dragafter ifn-sealed"></div>            
            <div class="tools">
              <!-- <button title="Select Color for this bookmark">${paintbrush} </button> -->
              <button class="ifn-sealed" title="Rename Bookmark" onclick="rename(event)">${textCursorInput} </button>
              <space></space>
              <div title="Change order" class="movegrip" onmousedown="startdrag(event)">${gripHorizontal}</div>
              <space></space>
              <button class="ifn-sealed" title="Remove Bookmark &#013;Shift+Click to skip confirmation" onclick="remove(event)">${circleX} </button>
            </div>
            <div class="textblock" onclick="openProject('${project.label}')" >
              <!-- <span data-field="project.typesvg"></span> -->
              <div data-field="project.label">
                Project Label
              </div>
            </div>
            <div class="pictoral">
              <div class="icon" data-field="project.typesvg"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="group">
      <button onclick="createGroup()" title="Create new group">${squarePlus}</button>
    </div>

    <!-- <pre id="pseudoconsole" style="background-color: black; color:silver; ">
      initing..
    </pre> -->


    <script>
      const vscode = acquireVsCodeApi();


      function diag(msg)
      {
        console.log('💎',msg);
        //document.getElementById('pseudoconsole').innerText = msg;
      }

      function alert(msg)
      {
        vscode.postMessage({command:'test',text:'🐕 alerting: '+msg});
      }

      const typesvg_folder = '${folder}';
      const typesvg_workspace = '${fileSliders}';
      const typesvg_question = '${fileQuestion}';

      let prototypes = 
      {
        group:null,
        project:null
      };

      function initPrototypes()
      {        
        prototypes.group= document.querySelector('div[data-prototype].group');
        prototypes.project= prototypes.group.querySelector('div[data-prototype].project');
      }
      
      function addGroup(landingPageGroup)
      {
        let newGroup=prototypes.group.cloneNode(true);
        delete newGroup.dataset['prototype'];
        newGroup.dataset['guid']=landingPageGroup.guid;
        
        // for(const labeled of newGroup.querySelectorAll('[data-field="group.label"]'))
        //   labeled.innerText = landingPageGroup.label;

        prototypes.group.parentElement.appendChild( newGroup );

        //landingPageGroup.projects.forEach((landingPageProject)=>{addProject(landingPageProject,newGroup)});      
        return newGroup;
      }

      function addProject(landingPageProject, elGroup)
      {
        let newPro=prototypes.project.cloneNode(true);
        delete newPro.dataset['prototype'];
        newPro.dataset['guid']=landingPageProject.guid;
        
        // for(const labeled of newPro.querySelectorAll('[data-field="project.label"]'))
        //   labeled.innerText = landingPageProject.label;

        
        // let svg = typesvg_folder;
        // if (Math.random()>0.499) svg = typesvg_workspace;

        // for(const labeled of newPro.querySelectorAll('[data-field="project.typesvg"]'))
        //   labeled.innerHTML = svg;

        elGroup.querySelector('.projects').appendChild( newPro );
        return newPro;
      }

      function rename(event)
      {
        console.log('clicked group', event);
        const guidProvider = event.target.closest('[data-guid]');
        if (guidProvider) vscode.postMessage({command:'rename',guid:guidProvider.dataset['guid']});
        else alert('Cannot rename, closest guid not found.');
      }

      function remove(event)
      {
        const guidProvider = event.target.closest('[data-guid]');
        if (guidProvider) vscode.postMessage({command:'remove',guid:guidProvider.dataset['guid'], dontAsk:event.shiftKey});
        else alert('Cannot remove, closest guid not found.');
      }

      function createBookmark(pickFolder)
      {
        console.log('createBookmark()');
        const guidProvider = event.target.closest('[data-guid]');
        if (guidProvider) vscode.postMessage({command:'createBookmark',guid:guidProvider.dataset['guid'],pickFolder:pickFolder});
        else alert('Cannot create bookmark, closest guid not found.');
      }

      function createGroup()
      {
        console.log('createGroup()');
        vscode.postMessage({command:'createGroup'});        
      }

      function openProject()
      {
        console.log('open()');
        const guidProvider = event.target.closest('[data-guid]');
        if (guidProvider) vscode.postMessage({command:'open',guid:guidProvider.dataset['guid']});
        else alert('Cannot open, closest guid not found.');
      }

      let draggingGUID=undefined;
      let draggingEl=undefined;
      let draggingSealed=false;
      let draggingGroup=false;
      function startdrag(event)
      {
        let guidProvider = event.target.closest('[data-guid]');
        if (!guidProvider) return;

        draggingGroup = guidProvider.classList.contains('group');
        draggingSealed = guidProvider.closest('.sealed')!==null;
        document.body.classList.add(draggingGroup?'is-dragging-group':'is-dragging');
        draggingEl=guidProvider;
        draggingEl.classList.add('dragged-item');
        draggingGUID=guidProvider.dataset['guid'];
        console.log(`start drag of ${draggingGUID}`,event);
      }

      function stopdrag(event)
      {
        document.body.classList.remove('is-dragging','is-dragging-group');
        console.log('stop drag',event);
        let newGUID;
        if (draggingSealed) 
        {
          newGUID = 'CC-'+(new Date().getTime()); //Caution: MUST be string
          draggingEl = draggingEl.cloneNode(true);
          draggingEl.dataset['guid'] = newGUID;
        }
        else newGUID=undefined;

        if (draggingGUID===undefined)return;        
        {
          if(event.target.classList.contains('dragbefore') || event.target.classList.contains('dragup'))
          {
            let dropGuidProvider = event.target.closest('[data-guid]');
            if (!dropGuidProvider) return;
            // console.log(`move ${draggingGUID} BEFORE ${dropGuidProvider.dataset['guid']}`);
            vscode.postMessage({command:'move',guid:draggingGUID, guid2: dropGuidProvider.dataset['guid'],pos:'before', cloneGUID:newGUID });
            dropGuidProvider.insertAdjacentElement('beforebegin', draggingEl);
          }
          else if(event.target.classList.contains('dragafter') || event.target.classList.contains('dragdown'))
          {
            let dropGuidProvider = event.target.closest('[data-guid]');
            if (!dropGuidProvider) return;
            // console.log(`move ${draggingGUID} AFTER ${dropGuidProvider.dataset['guid']}`);
            vscode.postMessage({command:'move',guid:draggingGUID, guid2: dropGuidProvider.dataset['guid'],pos:'after', cloneGUID:newGUID });
            dropGuidProvider.insertAdjacentElement('afterend', draggingEl);
          }
          else if (event.target.classList.contains('group-label')) //drop on group, i.e. to allow dropping in empty groups
          {
            let dropGuidProvider = event.target.closest('[data-guid]');
            if (!dropGuidProvider) return;
            // console.log(`move ${draggingGUID} AFTER ${dropGuidProvider.dataset['guid']}`);
            vscode.postMessage({command:'move',guid:draggingGUID, guid2: dropGuidProvider.dataset['guid'],pos:'<irrelvant>', cloneGUID:newGUID });
            dropGuidProvider.querySelector('.projects')?.appendChild(draggingEl);
          }
        }
        
        draggingGUID=undefined;
        draggingEl.classList.remove('dragged-item');
        draggingEl=null;
        draggingGroup=false;
        draggingSealed=false;
      }


      function modalHide(event)
      {
        // console.log('modal hide',event);
        document.querySelector('.modal').classList.add('hidden');
      }

      let contextCard = undefined;

      function modalPaletteShow(event)
      {
        contextCard = event.target.closest('[data-guid]');
        // console.log('modal palette SHOW',event,!contextCard?'NOT ContextCard':'HAS ContextCard');
        if (!contextCard) return;
        if (contextCard.closest('.sealed')) return; //.sealed in parent

        document.querySelector('.modal').classList.remove('hidden');
        let div = document.querySelector('.modal .palette');
        div.style.left = (event.clientX) + 'px';
        div.style.top = (event.clientY) + 'px';
      }
      function modalPaletteClick(event)
      {
        // console.log('modal palette click',event,!contextCard?'NOT ContextCard':'HAS ContextCard');
        if (!contextCard) return;

        let pickedShade=event.target.dataset['shade'];
        contextCard.dataset['shade']=pickedShade;
        vscode.postMessage({command:'patch',guid:contextCard.dataset['guid'], field:'shade', value:pickedShade});

        // console.log("🔴 shade",contextCard.dataset['shade'],'into', event.target.dataset['shade']);
        contextCard=null;
      }


      let model/*:LandingPageModel*/={};

      window.addEventListener('message', event => 
        {
        const message = event.data; // The JSON data our extension sent
        diag('got message! '+JSON.stringify(message));

        switch (message.command) 
        {
          case 'syncModel': 
            let elGUIDs = Array.from( document.querySelectorAll('[data-guid]:not([data-prototype])') ); //dom-elements linked to a guid
            let guidsInModel = []; //collecting all guids present in model (finds removed ones later)
            for(const landingPageGroup of message.model.groups)
            {
              try
              {
                guidsInModel.push(landingPageGroup.guid);

                let elGroup = elGUIDs.length==0? undefined : elGUIDs.find((element) => element.dataset['guid'] === landingPageGroup.guid);
                if (elGroup==undefined) //no html for this group yet, create
                {
                  elGroup = addGroup(landingPageGroup);
                  elGUIDs.push(elGroup);
                } 
                
                //--- update/sync html and data model
                for(const labeled of elGroup.querySelectorAll('[data-field="group.label"]'))
                  labeled.innerText = landingPageGroup.label;

                let isSealed = landingPageGroup.guid==='@vsc-mru'; //auto-generated list may be locked
                if (isSealed) elGroup.classList.add('sealed');

                //--
                
                for(const landingPageProject of landingPageGroup.projects)
                {
                  guidsInModel.push(landingPageProject.guid);

                  let elProject = elGUIDs.length==0? undefined : elGUIDs.find((element) => element.dataset['guid'] === landingPageProject.guid);
                  if (elProject==undefined) //no html for this project yet, create
                  {
                    elProject = addProject(landingPageProject, elGroup);
                    elGUIDs.push(elProject);
                  } 

                  //--- update/sync html and data model        
                  for(const labeled of elProject.querySelectorAll('[data-field="project.label"]'))
                    labeled.innerText = landingPageProject.label;
                  
                  let svg = typesvg_question;
                  if (landingPageProject.icon=='folder') svg = typesvg_folder;
                  else if (landingPageProject.icon=='workspace') svg = typesvg_workspace;
                  //else svg = typesvg_question;

                  for(const labeled of elProject.querySelectorAll('[data-field="project.typesvg"]'))
                    labeled.innerHTML = svg;

                  elProject.dataset['shade']=landingPageProject.shade;

                }   
              }catch(error) {console.error(error);}              
            }
            //remove DOM elements which are no longer in current model:
            elGUIDs.forEach((el)=>{
              let guid = el.dataset['guid'];
              if (guidsInModel.indexOf(guid)<0)
                el.remove();
            });
            break;
        }
      });


      (function() 
      {
        initPrototypes();

          // let count = 0;
          // setInterval(() => {
          //     counter.textContent = count++;

          //     // Alert the extension when our cat introduces a bug
          //     if (Math.random() < 0.001 * count) {
          //         vscode.postMessage({
          //             command: 'alert',
          //             text: '🐛  on line ' + count
          //         })
          //     }
          // }, 100);

          diag('🐕 docready!');
          vscode.postMessage({command:'documentReady'});

      }());
    </script>
  </body>
</html>